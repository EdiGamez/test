@ExtendWith(MockitoExtension.class)
class AdoUnderlyingServiceTest {

    @InjectMocks
    private AdoUnderlyingService service; // Cambia esto al nombre real de tu clase

    @Mock
    private Logger log;

    @Mock
    private UtilMomSerializer utilMomSerializer;

    @Mock
    private RcsService rcs; // Si usas una clase para inicializar `initStaticTables`

    private NewMsgGenericRequest request;
    private List<Output> outputList;

    @BeforeEach
    void setUp() {
        request = new NewMsgGenericRequest();
        request.setAssetClass("IR");
        request.setFactorType("VOL");
        request.setOutputs(new ArrayList<>());
        request.setIdFunctionality("funcId");
        request.setUnit("unit");
        request.setInputs(List.of());
        request.setOperation("GET");
        request.setSourceSystem("SYS");
        request.setResponseQueue("QUEUE");

        outputList = request.getOutputs();
    }

    @Test
    void shouldReturnOutputsFromListAdosDatapoints() {
        // Setup para que el primer proceso devuelva true
        AdoUnderlyingService spyService = Mockito.spy(service);

        Mockito.doReturn(true).when(spyService).checkIfIsLookingListAdosDatapoints(request);
        List<GetUnderlyingWithAdoResponse> mockResponseList = List.of(
                new GetUnderlyingWithAdoResponse("ADO1", "1M")
        );
        Mockito.doReturn(mockResponseList).when(spyService).executeGetUnderlyingWithAdoPointProcedure(request);

        NewMsgGenericResponse response = spyService.getAdoUnderlying(request);

        assertEquals(0, response.getErrorFlag());
        assertEquals(1, response.getOutputs().size());
        assertEquals("ADO1", response.getOutputs().get(0).getAdo());
    }

    @Test
    void shouldReturnOutputFromAdoDatapoint() {
        AdoUnderlyingService spyService = Mockito.spy(service);

        Mockito.doReturn(false).when(spyService).checkIfIsLookingListAdosDatapoints(request);
        Mockito.doReturn(true).when(spyService).checkIfIsLookingTheAdoOfDatapoint(request);
        Mockito.doReturn("ADO_DP").when(spyService).executeGetAdoDatapointFunction(request);

        NewMsgGenericResponse response = spyService.getAdoUnderlying(request);

        assertEquals(0, response.getErrorFlag());
        assertEquals(1, response.getOutputs().size());
        assertEquals("ADO_DP", response.getOutputs().get(0).getAdo());
    }

    @Test
    void shouldReturnOutputFromAdoUnderlying() {
        request.setAssetClass("FX");
        request.setFactorType("VOL");

        AdoUnderlyingService spyService = Mockito.spy(service);

        Mockito.doReturn(false).when(spyService).checkIfIsLookingListAdosDatapoints(request);
        Mockito.doReturn(true).when(spyService).checkIfIsLookingTheAdoOfDatapoint(request);
        Mockito.doReturn("ADO_U").when(spyService).executeGetAdoUnderlyingFunction(request);

        NewMsgGenericResponse response = spyService.getAdoUnderlying(request);

        assertEquals(0, response.getErrorFlag());
        assertEquals(1, response.getOutputs().size());
        assertEquals("ADO_U", response.getOutputs().get(0).getAdo());
    }

    @Test
    void shouldReturnErrorWhenNoProcessMatches() {
        AdoUnderlyingService spyService = Mockito.spy(service);

        Mockito.doReturn(false).when(spyService).checkIfIsLookingListAdosDatapoints(request);
        Mockito.doReturn(false).when(spyService).checkIfIsLookingTheAdoOfDatapoint(request);
        Mockito.doReturn(false).when(spyService).checkIfIsLookingAdoUnderlying(request);

        NewMsgGenericResponse response = spyService.getAdoUnderlying(request);

        assertEquals(1, response.getErrorFlag());
        assertEquals(RfrCommonCTES.Messages.INFO_NO_DATA_AVAILABLE, response.getErrorMessage());
        assertTrue(response.getOutputs().isEmpty());
    }

    @Test
    void shouldReturnErrorWhenExceptionOccurs() {
        AdoUnderlyingService spyService = Mockito.spy(service);

        Mockito.doThrow(new RuntimeException("Unexpected")).when(spyService).initStaticTables(any(), any());

        NewMsgGenericResponse response = spyService.getAdoUnderlying(request);

        assertEquals(1, response.getErrorFlag());
        assertEquals(RfrCommonCTES.Messages.INFO_NO_DATA_AVAILABLE, response.getErrorMessage());
    }
}
